<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>RouteGraph-RAG · Flight Recommender Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="app-root" class="app-root">
      <!-- Top bar -->
      <header class="app-header">
        <div class="header-main">
          <h1 class="app-title">RouteGraph-RAG</h1>
          <p class="app-tagline">
            Constraint-aware flight recommendations with route-graph and review signals.
          </p>
        </div>
      </header>

      <!-- Loading / error indicators -->
      <div id="loading-indicator" class="status-message" style="display: none;">
        Loading flights and precomputed scores…
      </div>
      <div
        id="error-indicator"
        class="status-message status-error"
        style="display: none;"
      >
        Something went wrong while loading data. Please refresh the page.
      </div>

      <main class="app-main">
        <!-- Left: search & constraints -->
        <aside class="controls-pane">
          <h2 class="pane-title">Search &amp; Constraints</h2>
          <form class="constraints-form" onsubmit="return false;">
            <!-- Origin -->
            <div class="form-field">
              <label for="origin-select">Origin</label>
              <select id="origin-select"></select>
            </div>

            <!-- Destination (options depend on origin) -->
            <div class="form-field">
              <label for="destination-select">Destination</label>
              <select id="destination-select"></select>
            </div>

            <!-- Max stops -->
            <div class="form-field">
              <label for="max-stops-select">Max stops</label>
              <select id="max-stops-select">
                <option value="any">Any</option>
                <option value="0">Non-stop only</option>
                <option value="1">Up to 1 stop</option>
                <option value="2">Up to 2 stops</option>
              </select>
            </div>

            <!-- Alliance preference -->
            <div class="form-field">
              <label for="alliance-select">Preferred alliance</label>
              <select id="alliance-select">
                <option value="any">No preference</option>
                <option value="SkyTeam">SkyTeam</option>
                <option value="Star Alliance">Star Alliance</option>
                <option value="Oneworld">Oneworld</option>
                <option value="None">None</option>
              </select>
            </div>

            <!-- Button -->
            <div class="form-actions">
              <button id="recommend-button" type="button">
                Recommend flights
              </button>
            </div>

            <p class="form-footnote">
              All scoring runs locally in your browser using precomputed model scores,
              route-graph features, and airline review statistics.
            </p>
          </form>
        </aside>

        <!-- Right: sort/filter + recommendations -->
        <section class="results-pane">
          <!-- Sort / Filters bar -->
          <section class="sort-filter-card">
            <div class="sort-filter-tabs">
              <button
                id="sort-tab"
                type="button"
                class="tab-button tab-button-active"
              >
                Sort by
              </button>
              <button id="filters-tab" type="button" class="tab-button">
                Filters
              </button>
            </div>

            <div class="sort-filter-body">
              <!-- Sort controls -->
              <div id="sort-controls" class="sort-section">
                <label class="radio-inline">
                  <input
                    type="radio"
                    name="sort-mode"
                    id="sort-recommended"
                    value="recommended"
                    checked
                  />
                  <span>Recommended (model ranking)</span>
                </label>
                <label class="radio-inline">
                  <input
                    type="radio"
                    name="sort-mode"
                    id="sort-cheapest"
                    value="cheapest"
                  />
                  <span>Cheapest first</span>
                </label>
                <label class="radio-inline">
                  <input
                    type="radio"
                    name="sort-mode"
                    id="sort-fastest"
                    value="fastest"
                  />
                  <span>Fastest first</span>
                </label>
              </div>

              <!-- Filter controls (simple time-of-day buckets etc.) -->
              <div
                id="filter-controls"
                class="filter-section"
                style="display: none;"
              >
                <div class="filter-group">
                  <span class="filter-label">Departure time</span>
                  <div class="chip-row">
                    <button
                      type="button"
                      class="chip chip-active"
                      data-departure-bucket="any"
                    >
                      Any
                    </button>
                    <button
                      type="button"
                      class="chip"
                      data-departure-bucket="morning"
                    >
                      6am–12pm
                    </button>
                    <button
                      type="button"
                      class="chip"
                      data-departure-bucket="afternoon"
                    >
                      12pm–6pm
                    </button>
                    <button
                      type="button"
                      class="chip"
                      data-departure-bucket="evening"
                    >
                      After 6pm
                    </button>
                  </div>
                </div>

                <div class="filter-group">
                  <span class="filter-label">Arrival time</span>
                  <div class="chip-row">
                    <button
                      type="button"
                      class="chip chip-active"
                      data-arrival-bucket="any"
                    >
                      Any
                    </button>
                    <button
                      type="button"
                      class="chip"
                      data-arrival-bucket="morning"
                    >
                      Before 6am
                    </button>
                    <button
                      type="button"
                      class="chip"
                      data-arrival-bucket="day"
                    >
                      6am–6pm
                    </button>
                    <button
                      type="button"
                      class="chip"
                      data-arrival-bucket="evening"
                    >
                      After 6pm
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Banner for constraint fallback -->
          <div id="constraints-banner" class="constraints-banner"></div>

          <!-- Two recommendation tables -->
          <div class="results-grid">
            <!-- Baseline column -->
            <section class="results-column">
              <h2 class="results-title">Standard recommendations</h2>
              <p class="results-subtitle">
                Ordered using core features like price, duration, and stops.
              </p>

              <div class="table-wrapper">
                <table class="flights-table" aria-label="Baseline recommendations">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Airline</th>
                      <th scope="col">Route</th>
                      <th scope="col">Departure</th>
                      <th scope="col">Duration</th>
                      <th scope="col">Stops</th>
                      <th scope="col">Price (₽)</th>
                      <th scope="col">Tags</th>
                    </tr>
                  </thead>
                  <tbody id="baseline-results"></tbody>
                </table>
              </div>
            </section>

            <!-- Hybrid column -->
            <section class="results-column">
              <h2 class="results-title">Smart recommendations</h2>
              <p class="results-subtitle">
                Uses route popularity, connectivity, reviews, and your alliance
                preference.
              </p>

              <div class="table-wrapper">
                <table class="flights-table" aria-label="Hybrid recommendations">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Airline</th>
                      <th scope="col">Route</th>
                      <th scope="col">Departure</th>
                      <th scope="col">Duration</th>
                      <th scope="col">Stops</th>
                      <th scope="col">Price (₽)</th>
                      <th scope="col">Tags</th>
                    </tr>
                  </thead>
                  <tbody id="hybrid-results"></tbody>
                </table>
              </div>
            </section>
          </div>
        </section>
      </main>
    </div>

    <!-- Dynamic origin → destination options (Option A) -->
    <script type="module">
      (async () => {
        try {
          const res = await fetch("../data/flights_small.json");
          if (!res.ok) {
            console.error("Failed to load flights_small.json", res.status);
            return;
          }
          const flights = await res.json();

          // Build origin -> set(destinations) map
          const originToDests = new Map();
          const origins = new Set();

          for (const f of flights) {
            const origin = f.origin || f.Origin || f.departure || f.Departure;
            const dest = f.dest || f.Destination || f.arrival || f.Arrival;

            if (!origin || !dest) continue;
            origins.add(origin);

            if (!originToDests.has(origin)) {
              originToDests.set(origin, new Set());
            }
            originToDests.get(origin).add(dest);
          }

          const originSelect = document.getElementById("origin-select");
          const destinationSelect = document.getElementById("destination-select");

          if (!originSelect || !destinationSelect) {
            console.warn("Origin/Destination selects not found in DOM");
            return;
          }

          // Populate origin dropdown
          const sortedOrigins = Array.from(origins).sort();
          originSelect.innerHTML = "";
          for (const o of sortedOrigins) {
            const opt = document.createElement("option");
            opt.value = o;
            opt.textContent = o;
            originSelect.appendChild(opt);
          }

          // Helper: repopulate destinations when origin changes
          function populateDestinationsForOrigin(originCode) {
            const destSet = originToDests.get(originCode);
            if (!destSet || destSet.size === 0) {
              destinationSelect.innerHTML = "";
              return;
            }

            const dests = Array.from(destSet).sort();
            const current = destinationSelect.value;

            destinationSelect.innerHTML = "";
            for (const d of dests) {
              const opt = document.createElement("option");
              opt.value = d;
              opt.textContent = d;
              destinationSelect.appendChild(opt);
            }

            if (current && destSet.has(current)) {
              destinationSelect.value = current;
            } else {
              destinationSelect.value = dests[0];
            }
          }

          // Wire change listener
          originSelect.addEventListener("change", () => {
            populateDestinationsForOrigin(originSelect.value);
          });

          // Initial origin & destination
          if (sortedOrigins.length > 0) {
            originSelect.value = sortedOrigins[0];
            populateDestinationsForOrigin(sortedOrigins[0]);
          }
        } catch (err) {
          console.error("Error building origin/dest options", err);
        }
      })();
    </script>

    <!-- Existing app entry (your JS modules use the selects and tables above) -->
    <script type="module" src="./app.js"></script>
  </body>
</html>
