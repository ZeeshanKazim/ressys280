<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content-Based Movie Recommender</title>
    <style>
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        #movie-select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        #recommend-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #recommend-btn:hover {
            background-color: #2980b9;
        }

        #recommend-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #result-box {
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
            min-height: 50px;
        }

        #result {
            margin: 0;
            font-weight: bold;
        }

        .loading {
            color: #7f8c8d;
        }

        .error {
            color: #e74c3c;
        }

        .recommendation-list {
            list-style-type: none;
            padding: 0;
        }

        .recommendation-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .recommendation-list li:last-child {
            border-bottom: none;
        }

        .hidden {
            display: none;
        }

        #data-status {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border-left: 4px solid #ffeeba;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Content-Based Movie Recommender</h1>
        <p>Select a movie you like, and we'll find similar ones for you!</p>
        
        <div class="input-group">
            <select id="movie-select">
                <option value="">-- Select a Movie --</option>
            </select>
            <button id="recommend-btn">Get Recommendations</button>
        </div>
        
        <div id="result-box">
            <p id="result">Loading data, please wait...</p>
        </div>
        
        <div id="data-status" class="hidden">
            <p>Using sample data. If you have the MovieLens dataset files (u.item and u.data), place them in the same folder for better results.</p>
        </div>
    </div>

    <script>
        // Global variables to store movie and rating data
        let movies = [];
        let ratings = [];
        let isDataLoaded = false;

        // Sample movie data as fallback
        const sampleMovies = [
            { id: 1, title: "Toy Story (1995)", genres: ["Animation", "Children's", "Comedy"] },
            { id: 2, title: "Jumanji (1995)", genres: ["Adventure", "Children's", "Fantasy"] },
            { id: 3, title: "Grumpier Old Men (1995)", genres: ["Comedy", "Romance"] },
            { id: 4, title: "Waiting to Exhale (1995)", genres: ["Comedy", "Drama", "Romance"] },
            { id: 5, title: "Father of the Bride Part II (1995)", genres: ["Comedy"] },
            { id: 6, title: "Heat (1995)", genres: ["Action", "Crime", "Thriller"] },
            { id: 7, title: "Sabrina (1995)", genres: ["Comedy", "Romance"] },
            { id: 8, title: "Tom and Huck (1995)", genres: ["Adventure", "Children's"] },
            { id: 9, title: "Sudden Death (1995)", genres: ["Action"] },
            { id: 10, title: "GoldenEye (1995)", genres: ["Action", "Adventure", "Thriller"] },
            { id: 11, title: "American President, The (1995)", genres: ["Comedy", "Drama", "Romance"] },
            { id: 12, title: "Dracula: Dead and Loving It (1995)", genres: ["Comedy", "Horror"] },
            { id: 13, title: "Balto (1995)", genres: ["Animation", "Children's"] },
            { id: 14, title: "Nixon (1995)", genres: ["Drama"] },
            { id: 15, title: "Cutthroat Island (1995)", genres: ["Action", "Adventure", "Romance"] },
            { id: 16, title: "Casino (1995)", genres: ["Crime", "Drama"] },
            { id: 17, title: "Sense and Sensibility (1995)", genres: ["Drama", "Romance"] },
            { id: 18, title: "Four Rooms (1995)", genres: ["Comedy", "Crime"] },
            { id: 19, title: "Ace Ventura: When Nature Calls (1995)", genres: ["Comedy"] },
            { id: 20, title: "Money Train (1995)", genres: ["Action", "Comedy", "Crime"] }
        ];

        // Sample rating data as fallback
        const sampleRatings = [
            { userId: 1, itemId: 1, rating: 5, timestamp: 887431883 },
            { userId: 1, itemId: 2, rating: 3, timestamp: 875693118 },
            { userId: 1, itemId: 3, rating: 4, timestamp: 888717495 },
            { userId: 2, itemId: 1, rating: 4, timestamp: 878542960 },
            { userId: 2, itemId: 4, rating: 5, timestamp: 886397596 },
            { userId: 2, itemId: 5, rating: 3, timestamp: 884182806 },
            { userId: 3, itemId: 6, rating: 5, timestamp: 881251949 },
            { userId: 3, itemId: 7, rating: 4, timestamp: 876862836 },
            { userId: 3, itemId: 8, rating: 3, timestamp: 878542960 }
        ];

        /**
         * Load and parse data from local files with fallback to sample data
         * @returns {Promise} Promise that resolves when data is loaded
         */
        async function loadData() {
            try {
                // Try to load movie data from u.item
                const moviesResponse = await fetch('u.item');
                if (moviesResponse.ok) {
                    const moviesText = await moviesResponse.text();
                    parseItemData(moviesText);
                    console.log('Loaded movie data from u.item');
                } else {
                    throw new Error('u.item not found');
                }
                
                // Try to load rating data from u.data
                const ratingsResponse = await fetch('u.data');
                if (ratingsResponse.ok) {
                    const ratingsText = await ratingsResponse.text();
                    parseRatingData(ratingsText);
                    console.log('Loaded rating data from u.data');
                } else {
                    throw new Error('u.data not found');
                }
                
            } catch (error) {
                console.log('Using fallback data:', error.message);
                // Use sample data as fallback
                movies = sampleMovies;
                ratings = sampleRatings;
                
                // Show message about fallback data
                document.getElementById('data-status').classList.remove('hidden');
            }
        }

        /**
         * Parse movie data from u.item file
         * @param {string} text - Raw text data from u.item
         */
        function parseItemData(text) {
            const genreNames = [
                "Action", "Adventure", "Animation", "Children's", "Comedy",
                "Crime", "Documentary", "Drama", "Fantasy", "Film-Noir",
                "Horror", "Musical", "Mystery", "Romance", "Sci-Fi",
                "Thriller", "War", "Western"
            ];
            
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            movies = lines.map(line => {
                const parts = line.split('|');
                if (parts.length < 5) return null;
                
                const movieId = parseInt(parts[0]);
                const title = parts[1];
                
                // Extract genre information (binary flags for 18 genres)
                const genres = [];
                for (let i = 0; i < 18; i++) {
                    const genreIndex = 5 + i;
                    if (parts.length > genreIndex && parts[genreIndex] === '1') {
                        genres.push(genreNames[i]);
                    }
                }
                
                return {
                    id: movieId,
                    title: title,
                    genres: genres
                };
            }).filter(movie => movie !== null);
        }

        /**
         * Parse rating data from u.data file
         * @param {string} text - Raw text data from u.data
         */
        function parseRatingData(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            ratings = lines.map(line => {
                const parts = line.split('\t');
                if (parts.length < 4) return null;
                
                return {
                    userId: parseInt(parts[0]),
                    itemId: parseInt(parts[1]),
                    rating: parseInt(parts[2]),
                    timestamp: parseInt(parts[3])
                };
            }).filter(rating => rating !== null);
        }

        /**
         * Initialize application when window loads
         */
        window.onload = async function() {
            const resultElement = document.getElementById('result');
            const recommendBtn = document.getElementById('recommend-btn');
            
            // Disable button until data is loaded
            recommendBtn.disabled = true;
            resultElement.textContent = 'Loading data, please wait...';
            
            try {
                // Wait for data to load
                await loadData();
                
                // Enable button and update status
                recommendBtn.disabled = false;
                resultElement.textContent = 'Data loaded. Please select a movie.';
                isDataLoaded = true;
                
                // Populate the movie dropdown
                populateMoviesDropdown();
                    
                // Add event listener to the recommendation button
                recommendBtn.addEventListener('click', getRecommendations);
            } catch (error) {
                console.error('Error initializing application:', error);
                resultElement.textContent = 'Error loading data. Please check the console for details.';
                resultElement.classList.add('error');
            }
        };

        /**
         * Populate the movie dropdown with available movies
         */
        function populateMoviesDropdown() {
            const movieSelect = document.getElementById('movie-select');
            
            // Clear existing options except the first one
            while (movieSelect.options.length > 1) {
                movieSelect.remove(1);
            }
            
            // Sort movies alphabetically by title
            const sortedMovies = [...movies].sort((a, b) => {
                return a.title.localeCompare(b.title);
            });
            
            // Add movies to dropdown
            sortedMovies.forEach(movie => {
                const option = document.createElement('option');
                option.value = movie.id;
                option.textContent = movie.title;
                movieSelect.appendChild(option);
            });
        }

        /**
         * Calculate Jaccard similarity between two sets
         * @param {Set} setA - First set
         * @param {Set} setB - Second set
         * @returns {number} Jaccard similarity coefficient
         */
        function calculateJaccardSimilarity(setA, setB) {
            const intersection = new Set([...setA].filter(x => setB.has(x)));
            const union = new Set([...setA, ...setB]);
            
            return union.size === 0 ? 0 : intersection.size / union.size;
        }

        /**
         * Get recommendations based on the selected movie
         */
        function getRecommendations() {
            if (!isDataLoaded) {
                document.getElementById('result').textContent = 'Data not loaded yet. Please wait.';
                return;
            }
            
            // Step 1: Get user input
            const movieSelect = document.getElementById('movie-select');
            const selectedMovieId = parseInt(movieSelect.value);
            const resultElement = document.getElementById('result');
            
            if (!selectedMovieId) {
                resultElement.textContent = 'Please select a movie first.';
                return;
            }
            
            // Step 2: Find liked movie
            const likedMovie = movies.find(movie => movie.id === selectedMovieId);
            if (!likedMovie) {
                resultElement.textContent = 'Selected movie not found.';
                return;
            }
            
            // Step 3: Prepare for similarity calculation
            const likedMovieGenres = new Set(likedMovie.genres);
            const candidateMovies = movies.filter(movie => movie.id !== likedMovie.id);
            
            // Step 4: Calculate similarity scores
            const scoredMovies = candidateMovies.map(candidateMovie => {
                const candidateGenres = new Set(candidateMovie.genres);
                const score = calculateJaccardSimilarity(likedMovieGenres, candidateGenres);
                
                return {
                    ...candidateMovie,
                    score: score
                };
            });
            
            // Step 5: Sort by score (descending)
            scoredMovies.sort((a, b) => b.score - a.score);
            
            // Step 6: Select top recommendations
            const topRecommendations = scoredMovies.slice(0, 5);
            
            // Step 7: Display results
            if (topRecommendations.length > 0) {
                let html = `<p>Because you liked "<strong>${likedMovie.title}</strong>", we recommend:</p>`;
                html += '<ul class="recommendation-list">';
                
                topRecommendations.forEach(movie => {
                    html += `<li>${movie.title} <em>(similarity: ${movie.score.toFixed(2)})</em></li>`;
                });
                
                html += '</ul>';
                resultElement.innerHTML = html;
            } else {
                resultElement.textContent = 'No recommendations found.';
            }
        }
    </script>
</body>
</html>
