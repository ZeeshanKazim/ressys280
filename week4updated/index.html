<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>MovieLens Two-Tower Recommender (TF.js + RAG + Qwen3-4B Docs)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f4f6fb;
            color: #111827;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto 40px auto;
            padding: 20px 24px 32px 24px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        h1 {
            margin-top: 0;
            margin-bottom: 4px;
            font-size: 26px;
            letter-spacing: 0.01em;
        }

        h2 {
            margin-top: 0;
        }

        .subtitle {
            margin-top: 0;
            margin-bottom: 16px;
            color: #4b5563;
            font-size: 14px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0 12px 0;
        }

        button {
            border-radius: 999px;
            border: none;
            padding: 10px 18px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
            background: #2563eb;
            color: #fff;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
            transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.15s ease-out;
        }

        button:hover:not(:disabled) {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.45);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.35);
        }

        button:disabled {
            opacity: 0.45;
            cursor: default;
            box-shadow: none;
        }

        .status {
            margin: 10px 0 16px 0;
            padding: 10px 12px;
            border-radius: 8px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            font-size: 14px;
            color: #1e3a8a;
            white-space: pre-wrap;
        }

        .chart-container {
            margin: 20px 0;
        }

        .chart-container h2 {
            margin: 0 0 4px 0;
            font-size: 18px;
        }

        .hint {
            margin: 0 0 4px 0;
            font-size: 13px;
            color: #6b7280;
        }

        canvas {
            display: block;
            width: 100%;
            max-width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #ffffff;
        }

        .results {
            margin-top: 24px;
        }

        .results h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 13px;
        }

        th,
        td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            text-align: left;
        }

        th {
            background-color: #f3f4f6;
            font-weight: 600;
        }

        .side-by-side {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .side-by-side > div {
            flex: 1 1 0;
            min-width: 260px;
        }

        .tips {
            margin-top: 26px;
            padding-top: 12px;
            border-top: 1px dashed #e5e7eb;
            font-size: 13px;
        }

        .tips h2 {
            margin: 0 0 6px 0;
            font-size: 15px;
        }

        .tips ul {
            margin: 4px 0 0 18px;
            padding: 0;
        }

        .tips li {
            margin-bottom: 4px;
        }

        code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
                monospace;
            font-size: 12px;
            background: #f9fafb;
            padding: 1px 3px;
            border-radius: 4px;
        }

        pre code {
            display: block;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            background: #0b1120;
            color: #e5e7eb;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 16px;
            }

            h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Two-Tower Movie Recommender (MovieLens 100K)</h1>
        <p class="subtitle">
            Stage-3 RecSys demo: TF.js two-tower retrieval in-browser + RAG-style text query.
            Optional backend LLM: <strong>Qwen/Qwen3-4B</strong> (Hugging Face).
        </p>

        <div class="controls">
            <button id="loadData">Load Data</button>
            <button id="train" disabled>Train</button>
            <button id="test" disabled>Test</button>
        </div>

        <div id="status" class="status">Click “Load Data” to start.</div>

        <div class="chart-container">
            <h2>Training Loss</h2>
            <p class="hint">Loss per batch (in-batch negatives). Lower is better.</p>
            <canvas id="lossChart" width="900" height="260"></canvas>
        </div>

        <div class="chart-container">
            <h2>Item Embeddings Projection (PCA)</h2>
            <p class="hint">Sampled item embeddings projected to 2D. Hover to inspect titles.</p>
            <canvas id="embeddingChart" width="900" height="520"></canvas>
        </div>

        <!-- Optional D3 graph area (PageRank / user-item graph) -->
        <!-- <div id="graph" style="width:100%;height:420px;margin-top:24px;"></div> -->

        <div id="results" class="results"></div>

        <div style="margin-top: 28px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
            <h2>RAG Text Query (Vector Search + Two-Tower)</h2>
            <p class="hint">
                Enter a natural-language query like
                <em>“dark sci-fi with AI, not too much action”</em>. We retrieve candidates by title similarity
                (vector search proxy), then re-rank them with the trained two-tower model for a user.
            </p>

            <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;">
                <label>
                    Query:&nbsp;
                    <input
                        id="queryText"
                        type="text"
                        style="min-width:260px; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px;"
                        placeholder="e.g. scary movie, no ghosts, just unsettling"
                    />
                </label>

                <label>
                    User ID (optional):&nbsp;
                    <input
                        id="queryUserId"
                        type="number"
                        style="width:90px; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px;"
                        placeholder="123"
                    />
                </label>

                <button id="querySearch">RAG Text Query</button>
            </div>

            <div id="queryResults" class="results"></div>
        </div>

        <div class="tips">
            <h2>How to Run This Demo</h2>
            <ul>
                <li>
                    Training runs entirely in your browser with TensorFlow.js. No Python server is required for the
                    two-tower model.
                </li>
                <li>
                    Folder layout for static hosting (GitHub Pages, Netlify, local HTTP server):
                    <code>index.html</code>, <code>app.js</code>, <code>two-tower.js</code>, <code>graph.js</code>,
                    and <code>data/u.data</code>, <code>data/u.item</code>.
                </li>
                <li>
                    If you open <code>index.html</code> via <code>file://</code>, browsers can block
                    <code>fetch()</code>. Use a simple HTTP server
                    (e.g. <code>python -m http.server</code>) or GitHub Pages.
                </li>
            </ul>

            <h2 style="margin-top:14px;">Optional LLM Backend: Qwen/Qwen3-4B (Hugging Face)</h2>
            <p style="margin:4px 0 8px 0;">
                For a full modern pipeline (Stage 1 encoder + Stage 2 ranker), you can run
                <strong>Qwen3-4B</strong> on a backend (Python) and call it from this front-end. Below is a minimal
                Hugging Face Transformers snippet to stand up a chat-style encoder/ranker:
            </p>

            <pre><code># Python backend (server side), not in the browser.
from transformers import AutoModelForCausalLM, AutoTokenizer

model_name = "Qwen/Qwen3-4B"

tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    torch_dtype="auto",
    device_map="auto"
)

prompt = "Give me a short introduction to large language model."
messages = [{"role": "user", "content": prompt}]

text = tokenizer.apply_chat_template(
    messages,
    tokenize=False,
    add_generation_prompt=True,
    enable_thinking=True  # thinking mode on
)

inputs = tokenizer([text], return_tensors="pt").to(model.device)
generated_ids = model.generate(**inputs, max_new_tokens=256)
output_ids = generated_ids[0][len(inputs.input_ids[0]):]

response = tokenizer.decode(output_ids, skip_special_tokens=True)
print(response)</code></pre>

            <p style="margin-top:8px;">
                You can wrap this backend as an OpenAI-compatible API (e.g. via sglang or vLLM), then extend
                <code>app.js</code> to POST your text query, get structured movie features or re-rank scores, and blend
                them with the two-tower CF scores.
            </p>
        </div>
    </div>

    <!-- Core libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- App code -->
    <script src="two-tower.js"></script>
    <script src="graph.js"></script>
    <script src="app.js"></script>
</body>
</html>
