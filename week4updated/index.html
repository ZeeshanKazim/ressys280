<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>MovieLens Two-Tower Recommender (TF.js + RAG Query)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f4f6fb;
            color: #111827;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto 40px auto;
            padding: 20px 24px 32px 24px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        h1 {
            margin-top: 0;
            margin-bottom: 4px;
            font-size: 26px;
            letter-spacing: 0.01em;
        }

        .subtitle {
            margin-top: 0;
            margin-bottom: 16px;
            color: #4b5563;
            font-size: 14px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0 12px 0;
        }

        button {
            border-radius: 999px;
            border: none;
            padding: 10px 18px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
            background: #2563eb;
            color: #fff;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
            transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.15s ease-out;
        }

        button:hover:not(:disabled) {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.45);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.35);
        }

        button:disabled {
            opacity: 0.45;
            cursor: default;
            box-shadow: none;
        }

        .status {
            margin: 10px 0 16px 0;
            padding: 10px 12px;
            border-radius: 8px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            font-size: 14px;
            color: #1e3a8a;
            white-space: pre-wrap;
        }

        .chart-container {
            margin: 20px 0;
        }

        .chart-container h2 {
            margin: 0 0 4px 0;
            font-size: 18px;
        }

        .hint {
            margin: 0 0 4px 0;
            font-size: 13px;
            color: #6b7280;
        }

        canvas {
            display: block;
            width: 100%;
            max-width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #ffffff;
        }

        .results {
            margin-top: 24px;
        }

        .results h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 13px;
        }

        th,
        td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            text-align: left;
        }

        th {
            background-color: #f3f4f6;
            font-weight: 600;
        }

        .side-by-side {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .side-by-side > div {
            flex: 1 1 0;
            min-width: 260px;
        }

        .tips {
            margin-top: 26px;
            padding-top: 12px;
            border-top: 1px dashed #e5e7eb;
            font-size: 13px;
        }

        .tips h2 {
            margin: 0 0 6px 0;
            font-size: 15px;
        }

        .tips ul {
            margin: 4px 0 0 18px;
            padding: 0;
        }

        .tips li {
            margin-bottom: 4px;
        }

        code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
                monospace;
            font-size: 12px;
            background: #f9fafb;
            padding: 1px 3px;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 16px;
            }

            h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Two-Tower Movie Recommender (MovieLens 100K)</h1>
        <p class="subtitle">
            Modern RecSys demo: RAG-style text query + TF.js two-tower retrieval on MovieLens 100K.
        </p>

        <div class="controls">
            <button id="loadData" type="button">Load Data</button>
            <button id="train" type="button" disabled>Train</button>
            <button id="test" type="button" disabled>Test</button>
        </div>

        <div id="status" class="status">Click “Load Data” to start.</div>

        <div class="chart-container">
            <h2>Training Loss</h2>
            <p class="hint">Loss per batch (in-batch negatives). Lower is better.</p>
            <canvas id="lossChart" width="900" height="260"></canvas>
        </div>

        <div class="chart-container">
            <h2>Item Embeddings Projection (PCA)</h2>
            <p class="hint">Sampled item embeddings projected to 2D. Hover to inspect movie titles.</p>
            <canvas id="embeddingChart" width="900" height="520"></canvas>
        </div>

        <div id="results" class="results"></div>

        <!-- RAG-style text query section -->
        <div style="margin-top: 28px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
            <h2>RAG Text Query</h2>
            <p class="hint">
                Describe what you want to watch, e.g.
                <em>"dark philosophical sci-fi, no ghosts"</em>.
                We do text retrieval over titles, then re-rank with the two-tower model.
            </p>

            <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;">
                <label>
                    Query:&nbsp;
                    <input
                        id="queryText"
                        type="text"
                        style="min-width:260px; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px;"
                        placeholder='dark philosophical sci-fi, no ghosts'
                    />
                </label>

                <label>
                    User ID (optional):&nbsp;
                    <input
                        id="queryUserId"
                        type="number"
                        style="width:90px; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px;"
                        placeholder="123"
                    />
                </label>

                <!-- THIS BUTTON IS PURELY LOCAL, NO HUGGINGFACE LINK -->
                <button id="querySearch" type="button">
                    Search (Text → Vector)
                </button>
            </div>

            <div id="queryResults" class="results"></div>
        </div>

        <div class="tips">
            <h2>How to host &amp; run</h2>
            <ul>
                <li>
                    Put files as:
                    <code>index.html</code>, <code>app.js</code>, <code>two-tower.js</code>,
                    and folder <code>data/</code> containing <code>u.data</code>, <code>u.item</code>.
                </li>
                <li>
                    On GitHub Pages, set the source to the branch that has these files at the repo root.
                </li>
                <li>
                    Locally, run from a simple HTTP server:
                    <code>python -m http.server 8000</code> and open
                    <code>http://localhost:8000</code>.
                </li>
            </ul>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>

    <!-- App code -->
    <script src="two-tower.js"></script>
    <script src="app.js"></script>
</body>
</html>
